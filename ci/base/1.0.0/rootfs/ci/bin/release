#!/usr/bin/env bash

# Builds Docker image and pushes to registry

set -o errexit    # always exit on error
set -o pipefail   # do not ignore exit codes when piping output

BUILD_DIR=${1:-"."}

# Load dependencies
source /ci/lib/stdlib.sh
source /ci/lib/env.sh

validate_env
env_info

docker_auth() {
  $(aws ecr get-login --region "${AWS_ECR_REGION}")
}

docker_auth > /dev/null

# TODO: skip release if can pull image?
# if docker pull works, exit 0

build_docker_image() {
  cd "${BUILD_DIR}"
  docker  build \
    --rm \
    -t "${IMAGE}" \
    .
}

build_docker_image

push_docker_image() {
	docker push "${IMAGE}"
}

push_docker_image
